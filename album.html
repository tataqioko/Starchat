<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
      (function() {
        try {
          // 使用同步的 localStorage 获取主题设置，这比数据库快得多
          const themeMode = localStorage.getItem('xphone-theme-mode'); 
          const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          
          if (themeMode === 'dark' || (themeMode === 'auto' && systemPrefersDark)) {
            document.documentElement.classList.add('dark');
          }
          // 如果是 'light' 或者 localStorage 中没设置，则不做任何事，保持默认
        } catch (e) {
          // 捕获异常，以防 localStorage 被禁用
        }
      })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
        
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Xphone">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <title>公共相册</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="sharedStyles.css">
    <script type="module" src="applyGlobalStyles.js" defer></script> 
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script type="module" src="./spotifyManager.js" defer></script>
   <style>
   .album-container {
        position: relative;
        aspect-ratio: 1 / 1;
        background-color: #f3f4f6;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
    }

    .album-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #photo-grid {
            display: grid;
            /* 关键代码：自动填充列，每列最小100px，最大平分剩余空间 */
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px; /* 相当于 Tailwind 的 gap-2 */
            padding: 16px; /* 相当于 Tailwind 的 p-4 */
            align-content: flex-start; /* 让内容从顶部开始紧凑排列 */
        }
   </style>
</head>
<body class="bg-gray-100">
    <input type="file" id="local-image-input" class="hidden" accept="image/*">

    <div class="w-full h-full mx-auto flex flex-col">
        <header class="app-header">
            <div class="flex items-center justify-between relative">
                <a href="index.html" class="header-btn p-1.5 -ml-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                </a>
                <h1 class="text-base font-semibold text-gray-800">公共相册</h1>
                <button id="add-photo-btn" class="header-btn p-1.5 -mr-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                </button>
            </div>
        </header>

        <main class="flex-grow main-content overflow-y-auto">
            <div id="photo-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 xl:grid-cols-8 gap-0">
                </div>
        </main>
    </div>

    <script type="module">
        import { db, uploadImage } from './db.js';
        import { showUploadChoiceModal, promptForInput, showToast, showConfirmModal } from './ui-helpers.js';

        // --- DOM Elements ---
        const gridEl = document.getElementById('photo-grid');
        const fileInput = document.getElementById('local-image-input');
        
        async function renderAlbum() {
            gridEl.innerHTML = '';
            const photos = await db.globalAlbum.toArray();
            if (photos.length === 0) {
                gridEl.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">相册是空的，点击右上角添加第一张照片吧。</p>';
                return;
            }

            photos.forEach(photo => {
                const photoContainer = document.createElement('div');
                photoContainer.className = 'relative aspect-square group';
                let thumbnailUrl = photo.url;
                // 检查URL是否是Cloudinary的URL
                if (thumbnailUrl.includes('res.cloudinary.com')) {
                    // 在 /upload/ 后插入变换参数 'w_200/'
                    thumbnailUrl = thumbnailUrl.replace('/upload/', '/upload/w_200/');
                }
                photoContainer.innerHTML = `
                    <img src="${thumbnailUrl}" title="${photo.description}" class="w-full h-full object-cover rounded-lg">
                    <div class="absolute inset-0 bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <button data-id="${photo.id}" class="delete-btn text-white bg-red-600 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">×</button>
                    </div>
                `;
                gridEl.appendChild(photoContainer);
            });
        }

        // --- New Unified Upload Flow ---
        async function handleAddPhoto() {
            const choice = await showUploadChoiceModal(fileInput);
            if (!choice) return; // 用户取消或流程已转交

            let imageUrl = null;

            if (choice.type === 'local') {
                try {
                    imageUrl = await uploadImage(choice.value); // choice.value 现在是 File 对象
                } catch (error) {
                    showToast(error.message, 'error');
                    console.error("上传或保存照片失败:", error);
                    return; // 上传失败则中止
                }
            } else if (choice.type === 'url') {
                imageUrl = choice.value;
            }

            if (imageUrl) {
                await processAndSavePhoto(imageUrl);
            }
        }

        
        
        async function processAndSavePhoto(url) {
            // 第四个参数 true 表示这个输入是可选的
            const description = await promptForInput('图片描述 (可选)', '给图片起个名字或描述，留空则AI无法使用', true, true, '');
            if (description === null) return;

            await db.globalAlbum.add({ url: url.trim(), description: description.trim() });
            await renderAlbum();
        }

        async function deletePhoto(photoId) {
            const confirmed = await showConfirmModal(
                '删除照片',
                '确定要从公共相册中删除这张照片吗？',
                '删除',
                '取消'
            );
            if (!confirmed) return;

            await db.globalAlbum.delete(photoId);
            await renderAlbum();
        }
        
        // --- Event Listeners Setup ---
        document.getElementById('add-photo-btn').addEventListener('click', handleAddPhoto);

        gridEl.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                const id = parseInt(deleteBtn.dataset.id);
                deletePhoto(id);
            }
        });

        // --- Initial render ---
        renderAlbum();
    </script>
</body>
</html>
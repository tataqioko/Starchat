<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
      (function() {
        try {
          // ä½¿ç”¨åŒæ­¥çš„ localStorage è·å–ä¸»é¢˜è®¾ç½®ï¼Œè¿™æ¯”æ•°æ®åº“å¿«å¾—å¤š
          const themeMode = localStorage.getItem('starchat-theme-mode'); 
          const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          
          if (themeMode === 'dark' || (themeMode === 'auto' && systemPrefersDark)) {
            document.documentElement.classList.add('dark');
          }
          // å¦‚æœæ˜¯ 'light' æˆ–è€… localStorage ä¸­æ²¡è®¾ç½®ï¼Œåˆ™ä¸åšä»»ä½•äº‹ï¼Œä¿æŒé»˜è®¤
        } catch (e) {
          // æ•è·å¼‚å¸¸ï¼Œä»¥é˜² localStorage è¢«ç¦ç”¨
        }
      })();
    </script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="StarChat">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <title>StarChat - èŠå¤©å®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <link rel="stylesheet" href="sharedStyles.css">
    <script type="module" src="applyGlobalStyles.js" defer></script> 
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script type="module" src="./spotifyManager.js" defer></script>
 
    <style>
        :root {
            --user-bubble-bg: #dcf8c6;
            --user-bubble-text: #000000;
            --ai-bubble-bg: #ffffff;
            --ai-bubble-text: #000000;
            --border-color: #e5e7eb;
            --accent-color: #3b82f6; /* Default accent color, will be updated by JS */
            --action-btn-bg-light: #f3f4f6; /* gray-100 */
            --action-btn-text-light: #374151; /* gray-700 */
            --action-btn-bg-dark: #252525;   /* gray-700, æ·±è‰²æ¨¡å¼ä¸‹çš„èƒŒæ™¯ */
            --action-btn-text-dark: #dcdcdc;  /* gray-300, æ·±è‰²æ¨¡å¼ä¸‹çš„æ–‡å­— */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        .header-btn { color: #555; transition: color 0.2s; }
        .header-btn:hover { color: var(--accent-color); }

        .chat-bubble {
            max-width: 100%; /* è®©æ°”æ³¡å¡«å……å…¶çˆ¶å®¹å™¨ */
            padding: 10px 14px;
            border-radius: 18px;
            overflow-wrap: break-word; /* è¿™æ˜¯ word-wrap çš„æ ‡å‡†åç§° */
            word-break: break-word;    /* ä¿ç•™ï¼Œç”¨äºå¼ºåˆ¶æ‰“æ–­é•¿å•è¯/å­—ç¬¦ä¸² */
        }
        .user-bubble { background-color: var(--user-bubble-bg); color: var(--user-bubble-text); border-bottom-right-radius: 4px; }
        .ai-bubble { background-color: var(--ai-bubble-bg); color: var(--ai-bubble-text); border-bottom-left-radius: 4px; }
        
        #chat-input:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 1px var(--accent-color) !important; outline: none; }
        
        .send-btn { background-color: var(--accent-color); color: white; }
        .send-btn:disabled { background-color: #bdc3c7; color: #7f8c8d; cursor: not-allowed; }

        /* Unified Action Button Style */
        .action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 9999px; /* full */
            background-color: var(--action-btn-bg-light); 
            color: var(--action-btn-text-light);
            transition: all 0.2s ease-in-out;
            
        }
        .action-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }
        .action-btn svg, .action-btn span {
            transition: color 0.2s ease-in-out;
        }
        .action-btn:hover svg, .action-btn:hover span {
             color: white;
        }

        html.dark .action-btn { 
                background-color: var(--action-btn-bg-dark);
                color: var(--action-btn-text-dark);
        }

        html.dark .action-btn:hover {
                background-color: var(--theme-color);
                color: white; /* æ‚¬æµ®æ—¶æ–‡å­—å˜ç™½ */
        }


        /* Modal Simplification */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 100; }
        .modal.visible { display: flex; }
        .modal-content { width: 90%; max-width: 400px; background-color: white; border-radius: 15px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-input { width: 100%; border: 1px solid var(--border-color); border-radius: 8px; outline: none; transition: all 0.2s; }
        .modal-input:focus { border-color: var(--accent-color) !important; box-shadow: 0 0 0 1px var(--accent-color) !important; }
        .modal-btn-confirm { background-color: var(--accent-color); color: white; }
        .modal-btn-cancel { background-color: #f3f4f6; color: #374151; }
        .modal-btn { width: 100%; padding: 12px; text-align: center; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        
        /* Sticker Panel Styles */
        #sticker-panel.visible { transform: translateY(0); visibility: visible; }
        #sticker-grid { flex-grow: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 15px; }
        .sticker-item { position: relative; aspect-ratio: 1 / 1; background-color: white; border-radius: 10px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .sticker-image { max-width: 100%; max-height: 100px; display: block; object-fit: contain; }
        .chat-bubble.is-sticker { padding: 0; background-color: transparent; box-shadow: none; }
        
        /* Transfer Styles */
        .chat-bubble.is-transfer { padding: 0; background: transparent; box-shadow: none; cursor: pointer; }
        .transfer-card {  width: 220px; max-width: 100%; border-radius: 12px; padding: 12px; position: relative; overflow: hidden; }
        .transfer-card::before { position: absolute; right: 10px; top: 5px; font-size: 30px; opacity: 0.2; transform: rotate(15deg); }
        .transfer-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 6px; margin-bottom: 8px; }
        .transfer-amount { font-size: 28px; font-weight: bold; margin-bottom: 4px; }
        .transfer-note { font-size: 13px; opacity: 0.9; border-top: 1px solid rgba(255,255,255,0.3); padding-top: 8px; margin-top: 8px; word-break: break-all; }
        
        /* Voice Message & Image Description Styles */
        .chat-bubble.is-voice-message, .chat-bubble.is-image { font-style: italic; }
        .chat-bubble.is-voice-message {
            padding: 0; /* ç§»é™¤é»˜è®¤å†…è¾¹è·ï¼Œä»¥ä¾¿å†…éƒ¨å…ƒç´ å¯ä»¥è‡ªå®šä¹‰å¸ƒå±€ */
            overflow: hidden; /* ç¡®ä¿å­å…ƒç´ åœ†è§’ç”Ÿæ•ˆ */
        }
        /* Video Call Styles */
        #video-call-screen { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: #1c1c1e; color: white; flex-direction: column; overflow: hidden; z-index: 500; }
        #video-call-screen.active { display: flex; }
        .participant-avatar.speaking { border-color: #4cd964; box-shadow: 0 0 20px rgba(76, 217, 100, 0.6); transform: scale(1.05); }

        /* Link Share Styles */
        .chat-bubble.is-link-share { padding: 0; background: transparent; box-shadow: none; }
        .link-share-card { width: 250px; background-color: #fff; border-radius: 10px; border: 1px solid #e0e0e0; padding: 12px; cursor: pointer; transition: background-color 0.2s; display: flex; flex-direction: column; gap: 8px; }
        .link-share-card:hover { background-color: #f9f9f9; }
        .link-share-card .title { font-weight: 600; font-size: 15px; color: #1f1f1f; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .link-share-card .description { font-size: 13px; color: #8a8a8a; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; }
        .link-share-card .footer { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #8a8a8a; margin-top: 4px; }
        
        .message-content-group {
            width: -webkit-fit-content; /* å…¼å®¹æ—§ç‰ˆ Chrome/Safari */
            width: -moz-fit-content;    /* å…¼å®¹ Firefox */
            width: fit-content;         /* æ ‡å‡†è¯­æ³• */
            max-width: 100%; 
        }

        .message-content-column {
            /* 1 1 auto: å…è®¸å¢é•¿ï¼Œå…è®¸æ”¶ç¼©ï¼ŒåŸºç¡€å®½åº¦è‡ªåŠ¨ */
            flex: 1 1 auto;
            /* å…³é”®ä¿®å¤ï¼šå…è®¸flexé¡¹æ”¶ç¼©è‡³å°äºå…¶å†…å®¹å°ºå¯¸ï¼Œä»è€Œè§¦å‘å†…å®¹æ¢è¡Œ */
            min-width: 0;
        }

        
        /* 1. æ¶ˆæ¯è¡Œçš„åŸºç¡€å®¹å™¨ */
        .message-wrapper {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            position: relative;
            max-width: 90%; /* æœ€å¤§å®½åº¦ä¸ºèŠå¤©çª—å£çš„90% */
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none;   /* Safari */
            -khtml-user-select: none;    /* Konqueror HTML */
            -moz-user-select: none;      /* Old versions of Firefox */
            -ms-user-select: none;       /* Internet Explorer/Edge */
            user-select: none;           /* Non-prefixed version, currently supported by Chrome, Opera and Firefox */
        }

        /* 2. AIæ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰çš„å¯¹é½æ–¹å¼ */
        .message-wrapper.ai {
            align-self: flex-start; /* å°†æ•´ä¸ªæ¶ˆæ¯å—é å·¦ */
        }

        /* 3. ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰çš„å¯¹é½æ–¹å¼å’Œå†…éƒ¨é¡ºåº */
        .message-wrapper.user {
            align-self: flex-end; /* å°†æ•´ä¸ªæ¶ˆæ¯å—é å³ */
            flex-direction: row-reverse; /* åè½¬å†…éƒ¨å…ƒç´ é¡ºåºï¼Œå®ç°æ—¶é—´åœ¨å·¦ã€æ°”æ³¡åœ¨å³ */
        }
    
        /* Avatar styles */
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0; /* Prevents avatar from shrinking */
        }

        #status-dot {
            background-color: #ccc; /* Default gray color */
            transition: background-color 0.3s ease;
        }

        /* Timestamp styles */
        .timestamp {
            font-size: 11px;
            color: #999;
            white-space: nowrap; /* Prevents time from wrapping */
            margin-bottom: 5px;
            flex-shrink: 0;
        }

        /* voice message */
        .voice-message-body {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px 12px;
            min-width: 80px;
            max-width: 200px;
        }
        .user-bubble .voice-message-body { flex-direction: row-reverse; }

        .voice-waveform {
            display: flex;
            align-items: center;
            height: 20px;
            gap: 2px;
            flex-grow: 1;
            margin: 0 10px;
        }
        .voice-waveform div {
            width: 3px;
            background-color: currentColor; /* Inherits text color */
            border-radius: 2px;
            animation: wave-quiet 1.5s ease-in-out infinite;
        }
        @keyframes wave-quiet {
            0%, 100% { height: 2px; }
            50% { height: 10px; }
        }
        /* Stagger the animation for a more natural look */
        .voice-waveform div:nth-child(2) { animation-delay: 0.2s; }
        .voice-waveform div:nth-child(3) { animation-delay: 0.4s; }
        .voice-waveform div:nth-child(4) { animation-delay: 0.6s; }
        .voice-waveform div:nth-child(5) { animation-delay: 0.8s; }

        .voice-duration {
            font-size: 13px;
            font-weight: 500;
        }

        /* typing */
        #char-name-header.typing-status {
            color: #9ca3af; /* A lighter gray color */
            font-style: italic;
            animation: typing-pulse 1.5s infinite;
        }
        @keyframes typing-pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .system-message {
            align-self: center;
            padding: 4px 12px;
            margin: 4px 0;
            /* ä½¿ç”¨ä¸€ä¸ªæ›´ä¸é€æ˜çš„æµ…ç°è‰²èƒŒæ™¯å’Œæ·±è‰²æ–‡å­— */
            background-color: rgba(229, 231, 235, 0.7); /* ç­‰åŒäº bg-gray-200, ä½†æœ‰é€æ˜åº¦ */
            color: #4b5563; /* gray-600 */
            font-size: 0.75rem;
            border-radius: 9999px;
            text-align: center;
            max-width: 80%;
        }

        /* â–¼â–¼â–¼ çº¢åŒ…å¡ç‰‡æ ·å¼ â–¼â–¼â–¼ */
        .message-bubble.is-red-packet .content {
            padding: 0;
            background: transparent;
            box-shadow: none;
            border: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        .red-packet-card {
            width: 220px;
            max-width: 100%;
            border-radius: 8px;
            background: linear-gradient(160deg, #F96259, #E44D44);
            color: #ffd700; /* é‡‘è‰²æ–‡å­— */
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .red-packet-card.opened {
            background: linear-gradient(160deg, #d3c4a0, #c4b693);
            cursor: default;
        }

        .red-packet-card::before {
            content: 'ğŸ§§';
            position: absolute;
            top: -5px;
            left: -5px;
            font-size: 30px;
            opacity: 0.2;
            transform: rotate(-10deg);
        }

        .rp-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .rp-icon {
            width: 20px;
            height: 20px;
        }

        .rp-greeting {
            font-size: 15px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rp-type {
            font-size: 11px;
            color: white;
            opacity: 0.8;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }

        .rp-claimed-info {
            font-size: 13px;
            color: white;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.3);
        }

        /* â–¼â–¼â–¼ çº¢åŒ…è¯¦æƒ…åˆ—è¡¨æ ·å¼ â–¼â–¼â–¼ */
        .rp-details-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .rp-details-item:last-child {
            border-bottom: none;
        }
        .rp-details-item .name {
            flex-grow: 1;
            font-weight: 500;
            color: #333;
        }
        .rp-details-item .amount {
            font-weight: 500;
            color: #555;
        }
        .rp-details-item .lucky-king-tag {
            font-size: 10px;
            background-color: #ffd700;
            color: #a67c00;
            padding: 2px 5px;
            border-radius: 4px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Style for the new action menu buttons */
        .action-menu-btn {
            background: none;
            border: none;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .action-menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Styles for selection mode */

        .message-wrapper.selection-mode {
            padding-left: 48px;
            width: 100%; /* å¤šé€‰æ—¶å¼ºåˆ¶æ’‘æ»¡ï¼Œç¡®ä¿checkboxä½ç½®æ­£ç¡® */
            max-width: 100%;
        }

        .selection-checkbox {                     
            position: absolute; 
            left: 16px; 
            top: 50%; 
            transform: translateY(-50%);
            width: 20px; 
            height: 20px; 
            border: 2px solid var(--accent-color);
            border-radius: 50%; 
            background: #fff; 
            display:flex; 
            align-items:center; 
            justify-content:center;
        }
       .selection-checkbox.checked {
            background: var(--accent-color);
            color: #fff;
        }
        .selection-checkbox.checked::after {
            content: 'âœ”';
            font-size: 14px;
            line-height: 18px;
        }

        /* Quoted message style */
        .quoted-message {
            width: fit-content;
            max-width: 100%;
            padding: 6px 10px;
            margin-bottom: 6px;
            border-radius: 6px;
            font-size: 0.9em;
            opacity: 0.85;
            border-left: 4px solid var(--accent-color);
        }
        .quoted-sender {
            font-weight: 600;
        }
        .quoted-content {
            white-space:normal;  /* å…è®¸æ­£å¸¸æ¢è¡Œ */
            overflow:hidden;
            text-overflow:ellipsis;
            display:-webkit-box;
            -webkit-line-clamp:2;       /* æœ€å¤šä¸¤è¡Œï¼Œè¶…å‡ºçœç•¥å· */
            -webkit-box-orient:vertical;
        }
        #reply-preview-bar{ 
            border-left:4px solid var(--accent-color); 
        }

        #player-progress-bar {
            background-color: var(--accent-color);
        }
        /* === å¤–å–è¯·æ±‚å¡ç‰‡æ ·å¼ === */
        .waimai-card {
            width: 240px; max-width: 100%; border-radius: 12px; overflow: hidden;
            background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            color: #1f1f1f;
        }
        .waimai-card .waimai-header { display: flex; align-items: center; gap: 8px; padding: 10px 12px; border-bottom: 1px solid #f0f0f0; }
        .waimai-card .icon { width: 20px; height: 20px; }
        .waimai-card .waimai-main { padding: 12px; }
        .waimai-card .request-title { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .waimai-card .payment-box { background-color: #f9f9f9; border-radius: 8px; padding: 10px; text-align: center; }
        .waimai-card .amount { font-size: 28px; font-weight: 700; color: #1f1f1f; }
        .waimai-card .status-text { font-size: 14px; font-weight: 600; text-align: center; padding: 20px 0; }
        .waimai-card.paid .status-text { color: #28a745; }
        .waimai-card.rejected .status-text { color: #dc3545; }
        .waimai-user-actions { display: flex; gap: 10px; padding: 0 12px 12px 12px; }
        .waimai-user-actions button { flex: 1; padding: 8px; border-radius: 8px; border: 1.5px solid; font-size: 14px; font-weight: 600; cursor: pointer; }
        .waimai-pay-btn { background-color: #28a745; border-color: #1f7a33; color: white; }
        .waimai-decline-btn { background-color: #f8f9fa; border-color: #ced4da; color: #495057; }
        .chat-bubble.is-waimai-request {
            padding: 0;
            background: transparent;
            box-shadow: none;
        }
        /* Pat Animation */
        @keyframes pat-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
            20%, 40%, 60%, 80% { transform: translateX(3px); }
        }

        body.pat-animation {
            animation: pat-shake 0.4s ease-in-out;
        }

        body, html {
        overflow: hidden;
        }

        main#chat-container {
                padding-bottom: 1rem; /* å¢åŠ åº•éƒ¨å†…è¾¹è·ï¼Œé˜²æ­¢æœ€åä¸€æ¡æ¶ˆæ¯è¢«è¾“å…¥æ¡†é®æŒ¡ */
        }


        #call-screen-modal #call-name,
        #call-screen-modal #call-status,
        #call-screen-modal #call-speaking-indicator {
            /* ä¸ºæ‰€æœ‰å…³é”®æ–‡å­—æ·»åŠ ä¸€ä¸ªåŠé€æ˜çš„æ·±è‰²é˜´å½± */
            text-shadow: 0px 1px 4px rgba(0, 0, 0, 0.5);
        }

        #call-screen-modal {
                /* ä¿®æ”¹ padding ä»¥é€‚é…å®‰å…¨åŒºåŸŸ */
                padding: 1.5rem; /* 24px */
                padding-top: calc(env(safe-area-inset-top) + 1.5rem);
                padding-bottom: calc(env(safe-area-inset-bottom) + 1.5rem);
        }

        #call-info {
                /* ä¸ºå¤´åƒå’Œåå­—åŒºåŸŸå¢åŠ ä¸€ç‚¹é¡¶éƒ¨è¾¹è·ï¼Œé¿å…ç´§è´´çŠ¶æ€æ  */
                margin-top: 1rem; /* 16px */
        }

        @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
        }
        .animate-spin {
                animation: spin 1s linear infinite;
        }

        #sticker-panel-grid, #sticker-panel-grid * {
                user-select: none;
                -webkit-user-select: none; /* å…¼å®¹ Safari å’Œ Chrome */
                -moz-user-select: none;    /* å…¼å®¹ Firefox */
                -ms-user-select: none;     /* å…¼å®¹ IE/Edge */
        }

        .no-transition {
                transition: none !important;
        }

        footer.app-dock {
                position: relative;
                padding-bottom: env(safe-area-inset-bottom, 1rem);
        }

    </style>
</head>
<body class="bg-gray-100">
    <div class="w-full h-full mx-auto flex flex-col">
    <header class="app-header">
        <div class="flex items-center justify-between">
            <a href="javascript:history.back()" id = 'back-btn' class="header-btn p-1.5 -ml-1.5 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            </a>
            <div class="text-center">
                <h1 id="char-name-header" class="text-base font-semibold text-gray-800 leading-tight"></h1>
                <div id="status-container" class="flex items-center justify-center gap-1.5 h-4"> 
                    <span id="status-dot" class="w-2 h-2 rounded-full"></span>
                    <span id="char-status" class="text-xs text-gray-500">åœ¨çº¿</span>
                </div>
            </div> 
            
        <div class="flex items-center"> 
                <button id="manual-summary-btn" title="æ‰‹åŠ¨ç”Ÿæˆæ€»ç»“" class="header-btn p-1.5 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-pencil-square"
                                viewBox="0 0 16 16">
                                <path
                                        d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                                <path fill-rule="evenodd"
                                        d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5z" />
                        </svg>
                </button>
        
                <a id="char-profile-link" href="#" class="header-btn p-1.5 -mr-1.5 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                        </svg>
                </a>
        </div>
        </div>
        <div id="selection-header" class="hidden flex items-center justify-between w-full">
            <button id="cancel-selection-btn" class="text-sm text-blue-500 font-semibold">å–æ¶ˆ</button>
            <span id="selection-count" class="text-base font-semibold text-gray-800"></span>
            <button id="delete-selection-btn" class="text-sm text-red-500 font-semibold">åˆ é™¤</button>
        </div>
    </header>

        <div id="music-player-bar" class="hidden sticky z-10 bg-white/80 backdrop-blur-md shadow-md p-3 mx-2 rounded-lg border" style="top: calc(var(--header-height, 56px) + 8px);">        <div class="flex items-center gap-3">
            <div class="flex-shrink-0">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="text-gray-500" viewBox="0 0 16 16"><path d="M8 3a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a6 6 0 1 1 12 0v5a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1V8a5 5 0 0 0-5-5z"/></svg>
            </div>
            
            <div class="flex-grow overflow-hidden">
                <p id="player-song-title" class="font-semibold text-sm truncate">æ­Œæ›²åç§°</p>
                <p id="player-song-artist" class="text-xs text-gray-500 truncate">æ­Œæ‰‹</p>
            </div>

            <div class="flex items-center justify-center gap-4 text-gray-800">
                <button id="player-shuffle-btn" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-shuffle" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.6 9.6 0 0 0 7.556 8a9.6 9.6 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.6 10.6 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.6 9.6 0 0 0 6.444 8a9.6 9.6 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5"/>
                    <path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192m0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192"/>
                    </svg>
                </button>
                <button id="player-prev-btn" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.5 3.5a.5.5 0 0 0-.5.5v8a.5.5 0 0 0 1 0V4a.5.5 0 0 0-.5-.5m-2.5.5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-.8.4l-4.5-3.5a.5.5 0 0 1 0-.8l4.5-3.5a.5.5 0 0 1 .8.4z"/>
                    </svg>
                </button>
                <button id="player-toggle-btn" class="p-1 w-12 h-12 flex items-center justify-center"></button> 
                <button id="player-next-btn" class="p-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M.5 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V4a.5.5 0 0 1 .5-.5m2.5.5a.5.5 0 0 0-.5.5v7a.5.5 0 0 0 .8.4l4.5-3.5a.5.5 0 0 0 0-.8L2.8 4.4a.5.5 0 0 0-.8.4z"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="relative w-full h-1 bg-gray-200 rounded-full mt-2">
            <div id="player-progress-bar" class="absolute h-full bg-blue-500 rounded-full"></div>
        </div>
    </div>

    <main id="chat-container" class="flex-grow main-content flex-1 px-6 pb-6 space-y-4">
        </main>

    <footer class="bg-white p-2 border-t app-dock">
        <div id="chat-input-actions-top" class="flex gap-2 p-2 overflow-x-auto">
            <button id="toggle-sticker-panel-btn" class="action-btn" title="è¡¨æƒ…é¢æ¿">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M4.285 9.567a.5.5 0 0 1 .683.183A3.498 3.498 0 0 0 8 11.5a3.498 3.498 0 0 0 3.032-1.75.5.5 0 1 1 .866.5A4.498 4.498 0 0 1 8 12.5a4.498 4.498 0 0 1-3.898-2.25.5.5 0 0 1 .183-.683zM7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5zm4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5z"/></svg>
            </button>
            <button id="send-media-btn" class="action-btn" title="å›¾ç‰‡">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/><path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12V3a1 1 0 0 1 1-1h12z"/></svg>
            </button>
            </button>
            <button id="transfer-btn" class="action-btn" title="è½¬è´¦">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-currency-dollar" viewBox="0 0 16 16"><path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73z"/></svg>
            </button>
            <button id="voice-message-btn" class="action-btn" title="å‘é€è¯­éŸ³(æ–‡å­—)">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z"/><path d="M10 8a2 2 0 1 1-4 0V3a2 2 0 1 1 4 0v5zM8 0a3 3 0 0 0-3 3v5a3 3 0 0 0 6 0V3a3 3 0 0 0-3-3z"/></svg>
            </button>
            <button id="send-waimai-request-btn" class="action-btn" title="å¤–å–ä»£ä»˜">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bag-heart" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10.5 3.5a2.5 2.5 0 0 0-5 0V4h5zm1 0V4H15v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V4h3.5v-.5a3.5 3.5 0 1 1 7 0M14 14V5H2v9a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1M8 7.993c1.664-1.711 5.825 1.283 0 5.132-5.825-3.85-1.664-6.843 0-5.132"/></svg>
            </button>
            <button id="share-link-btn" class="action-btn" title="åˆ†äº«é“¾æ¥">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M4.715 6.542 3.343 7.914a3 3 0 1 0 4.243 4.243l1.828-1.829A3 3 0 0 0 8.586 5.5L8 6.086a1.002 1.002 0 0 0-.154.199 2 2 0 0 1 .861 3.337L6.88 11.45a2 2 0 1 1-2.83-2.83l.793-.792a4.018 4.018 0 0 1-.128-1.287z"/><path d="M6.586 4.672A3 3 0 0 0 7.414 9.5l.775-.776a2 2 0 0 1-.896-3.346L9.12 3.55a2 2 0 1 1 2.83 2.83l-.793.792c.112.42.155.855.128 1.287l1.372-1.372a3 3 0 1 0-4.243-4.243L6.586 4.672z"/></svg>
            </button>
             <button id="listen-together-btn" class="action-btn" title="ä¸€èµ·å¬">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 3a5 5 0 0 0-5 5v1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V8a6 6 0 1 1 12 0v5a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1V8a5 5 0 0 0-5-5z"/>
                </svg>
            </button>
            <button id="start-call-btn" class="action-btn" title="é€šè¯">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-telephone" viewBox="0 0 16 16">
                    <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>
                </svg>
            </button>
            <button id="theme-toggle-btn" class="action-btn" title="åˆ‡æ¢ä¸»é¢˜è‰²">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 0a8 8 0 0 0 0 16V0z"/></svg>
            </button>
           
        </div>

        <div id="reply-preview-bar" class="hidden p-2 mx-2 mb-1 bg-gray-100 rounded">
            <div class="flex justify-between items-center">
                <div class="text-xs text-gray-600 overflow-hidden">
                    <div id="reply-to-name" class="font-semibold"></div>
                    <div id="reply-content-snippet" class="truncate"></div>
                </div>
                <button id="cancel-reply-btn" class="text-gray-500 text-xl">&times;</button>
            </div>
        </div>

        <form id="chat-form" class="flex items-end space-x-2 p-2">
            <textarea id="chat-input" rows="1" class="flex-1 p-2 border rounded-xl focus:outline-none resize-none" placeholder="è¾“å…¥æ¶ˆæ¯..." autocorrect="off" autocapitalize="off" spellcheck="false" inputmode="text"></textarea>
            <button id="wait-reply-btn" type="button" title="ç­‰å¾…å›å¤" class="action-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16"><path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/></svg>
            </button>
            <button id="send-btn" type="submit" class="send-btn rounded-full p-3 text-white shadow-md transition-all disabled:bg-gray-400 disabled:cursor-not-allowed">            
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" fill="currentColor"/></svg>
            </button>
        </form>

        <div id="sticker-panel" class="bg-gray-100 transition-all duration-300 ease-in-out" style="max-height: 0; overflow: hidden;">
            <div id="sticker-panel-grid" class="h-64 p-2 overflow-y-auto grid grid-cols-5 gap-2">
                </div>
        </div>
    </footer>

    <div id="chat-lock-overlay" class="hidden absolute bottom-0 left-0 right-0 bg-gray-100 p-4 border-t z-30">
        <div id="chat-lock-content" class="text-center space-y-3">
            </div>
    </div>

    <div id="message-actions-menu" class="hidden absolute z-[100]">
        <div class="bg-gray-700/90 backdrop-blur-sm rounded-xl p-1 flex items-center gap-1 shadow-lg">
            <button data-action="copy" class="action-menu-btn">å¤åˆ¶</button>
            <button data-action="favorite" class="action-menu-btn">æ”¶è—</button>
            <button data-action="reply" class="action-menu-btn">å¼•ç”¨</button>
            <button data-action="edit" class="action-menu-btn">ç¼–è¾‘</button>
            <button data-action="select" class="action-menu-btn">å¤šé€‰</button>
            <button data-action="delete" class="action-menu-btn text-red-400">åˆ é™¤</button>
        </div>
    </div>
    
    <div id="prompt-modal" class="modal z-40">
        <div class="modal-content">
            <div class="p-4 border-b">
                <h3 id="prompt-title" class="text-lg font-semibold text-center text-gray-800"></h3>
            </div>
            <div class="p-4">
                <textarea id="prompt-input" class="w-full p-2 border rounded-md modal-input" rows="3"></textarea>
            </div>
            <div class="flex border-t">
                <button id="prompt-cancel-btn" class="modal-btn modal-btn-cancel">å–æ¶ˆ</button>
                <button id="prompt-confirm-btn" class="modal-btn modal-btn-confirm">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div id="transfer-modal" class="modal z-40">
        <div class="modal-content bg-gray-50">
            <h3 class="text-lg font-semibold text-gray-800 text-center p-4 border-b">è½¬è´¦</h3>
            <div class="p-4 space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">è½¬è´¦é‡‘é¢</label>
                    <input type="number" id="transfer-amount" placeholder="0.00" class="w-full mt-1 p-2 modal-input">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">å¤‡æ³¨ (å¯é€‰)</label>
                    <input type="text" id="transfer-note" placeholder="ç»™å¯¹æ–¹ç•™è¨€" class="w-full mt-1 p-2 modal-input">
                </div>
            </div>
            <div class="flex">
                <button id="transfer-cancel-btn" class="modal-btn modal-btn-cancel">å–æ¶ˆ</button>
                <button id="transfer-confirm-btn" class="modal-btn modal-btn-confirm">ç¡®è®¤è½¬è´¦</button>
            </div>
        </div>
    </div>

    <div id="red-packet-modal" class="modal z-40">
        <div class="modal-content">
            <div class="p-3 border-b text-center">
                <h3 class="text-lg font-semibold text-gray-800">å‘çº¢åŒ…</h3>
            </div>
            <div class="bg-gray-50">
                <div class="flex border-b bg-white">
                    <div id="rp-tab-group" class="flex-1 p-3 text-center cursor-pointer font-semibold border-b-2" style="color: var(--accent-color); border-color: var(--accent-color);">æ‹¼æ‰‹æ°”çº¢åŒ…</div>
                    <div id="rp-tab-direct" class="flex-1 p-3 text-center cursor-pointer text-gray-500">ä¸“å±çº¢åŒ…</div>
                </div>
    
                <div class="p-4">
                    <div id="rp-content-group" class="space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">æ€»é‡‘é¢ (å…ƒ)</label>
                            <input type="number" id="rp-group-amount" placeholder="0.00" class="w-full mt-1 p-2 modal-input">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">çº¢åŒ…ä¸ªæ•°</label>
                            <input type="number" id="rp-group-count" placeholder="å¡«å†™çº¢åŒ…ä¸ªæ•°" class="w-full mt-1 p-2 modal-input">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">ç¥ç¦è¯­</label>
                            <input type="text" id="rp-group-greeting" placeholder="æ­å–œå‘è´¢ï¼Œå¤§å‰å¤§åˆ©ï¼" class="w-full mt-1 p-2 modal-input">
                        </div>
                        <p id="rp-group-total" class="text-center text-3xl font-bold py-2 text-gray-800">Â¥ 0.00</p>
                        <button id="send-group-packet-btn" class="w-full p-3 rounded-lg text-white font-semibold transition" style="background-color: var(--accent-color);">å¡é’±è¿›çº¢åŒ…</button>
                    </div>
    
                    <div id="rp-content-direct" class="hidden space-y-4">
                        <div>
                            <label class="text-sm font-medium text-gray-600">å‘é€ç»™</label>
                            <select id="rp-direct-receiver" class="w-full mt-1 p-2 modal-input"></select>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">é‡‘é¢ (å…ƒ)</label>
                            <input type="number" id="rp-direct-amount" placeholder="0.00" class="w-full mt-1 p-2 modal-input">
                        </div>
                        <div>
                            <label class="text-sm font-medium text-gray-600">ç¥ç¦è¯­</label>
                            <input type="text" id="rp-direct-greeting" placeholder="ç»™ä½ å‡†å¤‡äº†ä¸€ä¸ªçº¢åŒ…" class="w-full mt-1 p-2 modal-input">
                        </div>
                        <p id="rp-direct-total" class="text-center text-3xl font-bold py-2 text-gray-800">Â¥ 0.00</p>
                        <button id="send-direct-packet-btn" class="w-full p-3 rounded-lg text-white font-semibold transition" style="background-color: var(--accent-color);">å¡é’±è¿›çº¢åŒ…</button>
                    </div>
                </div>
            </div>
            <div class="flex border-t">
                <button id="cancel-red-packet-btn" class="modal-btn modal-btn-cancel w-full">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    
    <div id="red-packet-details-modal" class="modal z-50">
        <div class="modal-content bg-gray-100">
            <div class="bg-red-500 text-white text-center p-3 pt-4 rounded-t-lg">
                <div id="rp-details-sender" class="font-semibold"></div>
                <div class="text-sm opacity-90">çš„çº¢åŒ…</div>
            </div>
            <div class="p-4">
                <p id="rp-details-greeting" class="text-center text-xl text-gray-700 my-4"></p>
                <div id="rp-details-my-amount" class="hidden text-center mb-4">
                    <span class="text-4xl font-bold text-red-600"></span>
                    <span class="text-lg text-red-600">å…ƒ</span>
                </div>
                <div id="rp-details-summary" class="text-xs text-gray-500 border-t pt-2"></div>
                <div id="rp-details-list" class="max-h-32 overflow-y-auto mt-2 space-y-2">
                    </div>
            </div>
            <div class="flex border-t">
                <button id="close-rp-details-btn" class="modal-btn modal-btn-confirm w-full" style="background-color: transparent; color: #555;">å…³é—­</button>
            </div>
        </div>
    </div>

    <div id="share-link-modal" class="modal z-40">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-center p-4 border-b text-gray-800">åˆ†äº«é“¾æ¥</h3>
            <div class="p-4 space-y-3">
                <input id="link-title-input" type="text" placeholder="æ ‡é¢˜ (å¿…å¡«)" class="w-full p-2 border rounded-md modal-input">
                <textarea id="link-description-input" placeholder="æ‘˜è¦ (å¯é€‰)" rows="2" class="w-full p-2 border rounded-md modal-input"></textarea>
                <input id="link-source-input" type="text" placeholder="æ¥æºåç§° (å¯é€‰)" class="w-full p-2 border rounded-md modal-input">
                <textarea id="link-content-input" placeholder="å®Œæ•´å†…å®¹ (å¯é€‰)" rows="4" class="w-full p-2 border rounded-md modal-input"></textarea>
            </div>
            <div class="flex border-t">
                <button id="cancel-share-link-btn" class="modal-btn modal-btn-cancel">å–æ¶ˆ</button>
                <button id="confirm-share-link-btn" class="modal-btn modal-btn-confirm">åˆ†äº«</button>
            </div>
        </div>
    </div>

    <div id="playlist-modal" class="modal z-40">
        <div class="modal-content">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold text-center text-gray-800">é€‰æ‹©ä¸€ä¸ªæ­Œå•ä¸€èµ·å¬</h3>
            </div>
            <div id="playlist-selection-container" class="p-4 overflow-y-auto max-h-80">
                </div>
            <div class="flex border-t">
                <button id="playlist-cancel-btn" class="modal-btn modal-btn-cancel w-full">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="waimai-request-modal" class="modal z-40">
        <div class="modal-content">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold text-center text-gray-800">å‘èµ·å¤–å–ä»£ä»˜</h3>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="text-sm font-medium text-gray-600">å•†å“ä¿¡æ¯</label>
                    <input type="text" id="waimai-product-info" placeholder="ä¾‹å¦‚ï¼šä¸€æ¯æ¨æç”˜éœ²" class="w-full mt-1 p-2 modal-input">
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-600">ä»£ä»˜é‡‘é¢ (å…ƒ)</label>
                    <input type="number" id="waimai-amount" placeholder="ä¾‹å¦‚ï¼š21.5" class="w-full mt-1 p-2 modal-input">
                </div>
            </div>
            <div class="flex border-t">
                <button id="waimai-cancel-btn" class="modal-btn modal-btn-cancel">å–æ¶ˆ</button>
                <button id="waimai-confirm-btn" class="modal-btn modal-btn-confirm">å‘èµ·è¯·æ±‚</button>
            </div>
        </div>
    </div>
    
    <div id="call-screen-modal" class="hidden fixed inset-0 bg-gray-800 z-[200] flex flex-col items-center justify-between p-6 text-white">
        <div id="call-info" class="text-center">
            <img id="call-avatar" src="https://files.catbox.moe/kkll8p.svg" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg">
            <p id="call-name" class="text-2xl font-semibold mt-4">Character Name</p>
            <p id="call-status" class="text-xl text-gray-300 mt-2">00:00</p>
            <p id="call-speaking-indicator" class="text-lg text-gray-400 h-6 mt-1 opacity-0 transition-opacity"></p>

        </div>

        <div id="call-participant-list" class="w-full flex justify-center items-center gap-3 py-2 px-4 overflow-x-auto">
            </div>

        <div id="call-system-notice" class="h-6 text-sm text-center text-gray-300"></div>


        <div class="w-full flex-grow my-4 flex flex-col gap-4 min-h-0">
            <div id="voice-content-area" class="w-full flex-grow hidden bg-black/20 rounded-lg p-4 overflow-y-auto text-left space-y-2">
                </div>

            <div id="video-content-area" class="w-full flex-grow flex flex-col gap-4 hidden">
                 <div id="video-description-box" class="flex-1 bg-black/20 rounded-lg p-4 overflow-y-auto">
                    </div>
                <div id="video-dialogue-box" class="flex-1 bg-black/20 rounded-lg p-4 overflow-y-auto">
                    </div>
            </div>
        </div>

        <div class="w-full">
            <div id="call-input-container" class="hidden w-full max-w-md mx-auto mb-4">
                <form id="call-input-form" class="flex items-center gap-2">
                    
                    <input id="call-input" type="text" class="flex-1 p-2 bg-white/20 rounded-full border border-white/30 focus:outline-none focus:ring-2 focus:ring-white placeholder:text-gray-300" placeholder="è¯´ç‚¹ä»€ä¹ˆ...">
                    <button id="generate-call-response-btn" type="button" title="è®©å¯¹æ–¹è¯´è¯" class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-stars" viewBox="0 0 16 16"><path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM3.794 1.148a.217.217 0 0 1 .412 0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217 0 0 1 0 .412l-1.162.387A1.73 1.73 0 0 0 4.593 5.69l-.387 1.162a.217.217 0 0 1-.412 0L3.407 5.69A1.73 1.73 0 0 0 2.31 4.593l-1.162-.387a.217.217 0 0 1 0-.412l1.162-.387A1.73 1.73 0 0 0 3.407 2.31zM10.863.099a.145.145 0 0 1 .274 0l.258.774c.115.346.386.617.732.732l.774.258a.145.145 0 0 1 0 .274l-.774.258a1.16 1.16 0 0 0-.732.732l-.258.774a.145.145 0 0 1-.274 0l-.258-.774a1.16 1.16 0 0 0-.732-.732L9.1 2.137a.145.145 0 0 1 0-.274l.774-.258c.346-.115.617-.386.732-.732z"/></svg>
                    </button>
                    <button type="submit" class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z" fill="white"/></svg>
                    </button>
                </form>
            </div>

            <div class="flex justify-center">
                <button id="hang-up-btn" class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" class="bi bi-telephone-x" viewBox="0 0 16 16">
                        <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877z"/>
                        <path fill-rule="evenodd" d="M11.146 1.646a.5.5 0 0 1 .708 0L13 2.793l1.146-1.147a.5.5 0 0 1 .708.708L13.707 3.5l1.147 1.146a.5.5 0 0 1-.708.708L13 4.207l-1.146 1.147a.5.5 0 0 1-.708-.708L12.293 3.5l-1.147-1.146a.5.5 0 0 1 0-.708"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    <div id="incoming-call-modal" class="hidden fixed inset-0 bg-black/70 z-[250] flex flex-col items-center justify-between p-8 text-white transition-opacity duration-300">
        <div class="text-center mt-12">
            <img id="incoming-call-avatar" src="https://files.catbox.moe/kkll8p.svg" class="w-24 h-24 rounded-full mx-auto border-4 border-white shadow-lg animate-pulse">
            <p id="incoming-call-name" class="text-2xl font-semibold mt-4">Character Name</p>
            <p id="incoming-call-status" class="text-lg mt-1">è§†é¢‘é€šè¯</p>
        </div>

        <div class="w-full flex justify-around items-center">
            <div class="text-center">
                <button id="reject-incoming-call-btn" class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58L3.654 1.328zM1.884.511a1.745 1.745 0 0 1 2.612.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.68.68 0 0 0 .178.643l2.457 2.457a.68.68 0 0 0 .644.178l2.189-.547a1.75 1.75 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.6 18.6 0 0 1-7.01-4.42 18.6 18.6 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/>
                    </svg>
                </button>
                <p class="mt-2">æ‹’æ¥</p>
            </div>
            <div class="text-center">
                <button id="accept-incoming-call-btn" class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M3.654 1.328a.678.678 0 0 0-1.015-.063L1.605 2.3c-.483.484-.661 1.169-.45 1.77a17.6 17.6 0 0 0 4.168 6.608 17.6 17.6 0 0 0 6.608 4.168c.601.211 1.286.033 1.77-.45l1.034-1.034a.678.678 0 0 0-.063-1.015l-2.307-1.794a.68.68 0 0 0-.58-.122l-2.19.547a1.75 1.75 0 0 1-1.657-.459L5.482 8.062a1.75 1.75 0 0 1-.46-1.657l.548-2.19a.68.68 0 0 0-.122-.58L3.654 1.328z"/>
                    </svg>
                </button>
                <p class="mt-2">æ¥å¬</p>
            </div>
        </div>
    </div>

    <script type="module" src="chatRoom.js" defer></script>
    </div>
</body>
</html>
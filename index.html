<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
      (function() {
        try {
          // 使用同步的 localStorage 获取主题设置，这比数据库快得多
          const themeMode = localStorage.getItem('starchat-theme-mode'); 
          const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          
          if (themeMode === 'dark' || (themeMode === 'auto' && systemPrefersDark)) {
            document.documentElement.classList.add('dark');
          }
          // 如果是 'light' 或者 localStorage 中没设置，则不做任何事，保持默认
        } catch (e) {
          // 捕获异常，以防 localStorage 被禁用
        }
      })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="星链小手机">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <title>星链小手机</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.topology.min.js"></script>

    <script type="module" src="applyGlobalStyles.js" defer></script> 

    <link rel="stylesheet" href="sharedStyles.css">
    

    <style>
        :root {
            --theme-color: #3b82f6; 
        }
        body {
            font-family: 'Inter', sans-serif;
            /* 星链主题渐变背景 - 更深邃的太空渐变 */
            background: linear-gradient(135deg, #0c1426 0%, #1e1b4b 35%, #312e81 70%, #3730a3 100%);
            background-attachment: fixed;
        }
        .wallpaper-bg {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        /* Dock中的图标悬浮时，使用主题色作为光晕 */
        .app-icon-link:hover .icon-container {
             box-shadow: 0 0 15px 3px var(--theme-color);
        }

        /* 品牌logo动画效果 */
        .brand-logo {
            transition: all 0.3s ease-in-out;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }
        .brand-logo:hover {
            transform: scale(1.05);
            filter: drop-shadow(0 6px 12px rgba(0,0,0,0.4));
        }

        /* 品牌名称渐变效果 */
        .brand-title {
            background: linear-gradient(135deg, #ffffff, #e0e7ff);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: brandGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes brandGlow {
            0% { opacity: 0.9; }
            100% { opacity: 1; }
        }

        /* 品牌副标题效果 */
        .brand-subtitle {
            background: linear-gradient(135deg, rgba(255,255,255,0.8), rgba(224,231,255,0.6));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        main {
            padding-top: env(safe-area-inset-top);
        }

        /* 品牌标识区域 - 保持简洁 */

        /* 时钟区域 - 保持简洁 */

        /* 时钟发光效果 */
        #main-time {
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 2px 5px rgba(0,0,0,0.3);
            animation: clockPulse 4s ease-in-out infinite;
        }

        @keyframes clockPulse {
            0%, 100% { text-shadow: 0 0 20px rgba(255, 255, 255, 0.3), 0 2px 5px rgba(0,0,0,0.3); }
            50% { text-shadow: 0 0 30px rgba(255, 255, 255, 0.5), 0 2px 5px rgba(0,0,0,0.3); }
        }

        /* Dock栏增强效果 */
        .enhanced-dock {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            /* 移除浮动动画 */
        }

        /* 应用图标增强效果 */
        .app-icon-link {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .app-icon-link:hover .icon-container {
            transform: scale(1.1);
            /* 只保留放大效果 */
        }

        /* 美化应用图标容器 */
        .icon-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .app-icon-link:hover .icon-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25));
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="phone-screen" class="w-full h-full mx-auto flex flex-col wallpaper-bg">        
        <div id="summary-generating-toast" class="hidden absolute top-10 left-1/2 -translate-x-1/2 bg-black/50 backdrop-blur-md text-white px-4 py-2 rounded-lg z-50 text-sm text-center">
            <p>离线动态生成中...</p>
            <p class="text-xs opacity-75">请稍候，或关闭页面跳过</p>
        </div>
        <!-- 主屏幕内容 -->
        <main class="flex-grow flex flex-col items-center justify-center text-white" style="text-shadow: 0 2px 5px rgba(0,0,0,0.3);">
            <!-- 品牌标识区域 -->
            <div class="brand-area text-center mb-12">
                <div class="flex items-center justify-center mb-4">
                    <img src="./icons/icon-192x192.png" alt="星链小手机" class="brand-logo w-16 h-16 rounded-2xl shadow-lg mr-3">
                    <div class="text-left">
                        <h2 class="brand-title text-2xl font-semibold tracking-wide">星链小手机</h2>
                        <p class="brand-subtitle text-lg font-light">智能伴侣平台</p>
                    </div>
                </div>
                <p class="text-sm opacity-70 font-light tracking-wider">AI角色扮演聊天平台</p>
            </div>
            
            <!-- 时间和日期 -->
            <div class="clock-area text-center mb-16">
                <h1 id="main-time" class="text-7xl font-thin tracking-tighter">05:07</h1>
                <p id="main-date" class="text-xl font-medium opacity-90">星期日, 7月13日</p>
            </div>
        </main>
        
        <!-- App Dock -->
        <footer class="w-full p-4 pb-8 flex-shrink-0">
            <div class="enhanced-dock mx-auto max-w-md rounded-2xl p-4">
                <div class="grid grid-cols-4 gap-4 text-center text-white text-xs font-medium">
                    <!-- App: 聊天 -->
                    <a href="chat.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>

                        </div>
                        <span class="mt-1">聊天</span>
                    </a>

                    <!-- App: 动态 -->
                    <a href="summary.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" />
                        </svg>
                        </div>
                        <span class="mt-1">动态</span>
                    </a>
                    <!-- App: 相册 -->
                    <a href="album.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" />
                                <path d="M21 15l-5-5L5 21" />
                            </svg>
                        </div>
                        <span class="mt-1">相册</span>
                    </a>

                    <!-- App: 设置 -->
                    <a href="settings.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                            </svg>

                        </div>
                        <span class="mt-1">设置</span>
                    </a>

                    <!-- App: 个性化 -->
                    <a href="personalization.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.098 19.902a3.75 3.75 0 0 0 5.304 0l6.401-6.402M6.75 21A3.75 3.75 0 0 1 3 17.25V4.125C3 3.504 3.504 3 4.125 3h5.25c.621 0 1.125.504 1.125 1.125v4.072M6.75 21a3.75 3.75 0 0 0 3.75-3.75V8.197M6.75 21h13.125c.621 0 1.125-.504 1.125-1.125v-5.25c0-.621-.504-1.125-1.125-1.125h-4.072M10.5 8.197l2.88-2.88c.438-.439 1.15-.439 1.59 0l3.712 3.713c.44.44.44 1.152 0 1.59l-2.879 2.88M6.75 17.25h.008v.008H6.75v-.008Z" />
                            </svg>
                        </div>
                        <span class="mt-1">个性化</span>
                    </a>

                    <!-- App: 世界书 -->
                    <a href="worldbook.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                            </svg>
                        </div>
                        <span class="mt-1">世界书</span>
                    </a>

                    <a href="help.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                <path d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286m1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94"/>
                            </svg>
                        </div>
                        <span class="mt-1">帮助</span>
                    </a>

                    <!-- App: 用户须知 -->
                    <a href="notice.html" class="app-icon-link flex flex-col items-center">
                        <div class="icon-container w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-300">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-megaphone" viewBox="0 0 16 16">
                                <path d="M13 2.5a1.5 1.5 0 0 1 3 0v11a1.5 1.5 0 0 1-3 0zm-1 .724c-2.067.95-4.539 1.481-7 1.656v6.237a25 25 0 0 1 1.088.085c2.053.204 4.038.668 5.912 1.56zm-8 7.841V4.934c-.68.027-1.399.043-2.008.053A2.02 2.02 0 0 0 0 7v2c0 1.106.896 1.996 1.994 2.009l.496.008a64 64 0 0 1 1.51.03zm1.39 1.081q.428.032.85.078l.253 1.69a1 1 0 0 1-.983 1.187h-.548a1 1 0 0 1-.916-.599l-1.314-2.48a66 66 0 0 1 1.692.064q.491.026.966.06"/>
                            </svg>
                        </div>
                        <span class="mt-1">须知</span>
                    </a>
                    
                </div>
            </div>
        </footer>

        <script type = 'module'>
            import { db } from './db.js';
            import { runOfflineSimulation, startActiveSimulation } from './simulationEngine.js';
            
            function updateMainScreenClock() {
                const now = new Date();
                const dateOpts = { weekday: 'long', month: 'long', day: 'numeric' };
                const mainTimeEl = document.getElementById('main-time');
                const mainDateEl = document.getElementById('main-date');
        
                if (mainTimeEl) mainTimeEl.textContent = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: false });
                if (mainDateEl) mainDateEl.textContent = now.toLocaleDateString('zh-CN', dateOpts);
            }

            const recordOfflineTime = async () => {
                if (document.visibilityState === 'hidden' || event.type === 'pagehide') {
                    await db.globalSettings.update('main', { lastOnlineTime: Date.now() });
                    console.log(`页面状态变为 ${event.type}, 记录最后在线时间。`);
                }
            };
            document.addEventListener('visibilitychange', recordOfflineTime);
            window.addEventListener('pagehide', recordOfflineTime);     
        
            document.addEventListener('DOMContentLoaded', async () => {
                updateMainScreenClock();
                setInterval(updateMainScreenClock, 30000); 

                await runOfflineSimulation();
            });

            if ('serviceWorker' in navigator) {
              window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                  console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                  console.log('ServiceWorker registration failed: ', err);
                });
              });
            }
        </script>
</body>
</html>

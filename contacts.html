<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
      (function() {
        try {
          // 使用同步的 localStorage 获取主题设置，这比数据库快得多
          const themeMode = localStorage.getItem('xphone-theme-mode'); 
          const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          
          if (themeMode === 'dark' || (themeMode === 'auto' && systemPrefersDark)) {
            document.documentElement.classList.add('dark');
          }
          // 如果是 'light' 或者 localStorage 中没设置，则不做任何事，保持默认
        } catch (e) {
          // 捕获异常，以防 localStorage 被禁用
        }
      })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Xphone">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    
    <title>通讯录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <link rel="stylesheet" href="sharedStyles.css">
    <script type="module" src="applyGlobalStyles.js" defer></script> 
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script type="module" src="./spotifyManager.js" defer></script>
 
</head>
<body>
    <div class="w-full h-full mx-auto flex flex-col">
        <header class="app-header">
            <div class="flex items-center justify-between relative">
                 <a href="index.html" class="header-btn p-1.5 -ml-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                </a>
                <h1 class="text-base font-semibold text-gray-800"></h1>
                <div class="relative">
                    <button id="add-btn" class="header-btn p-1.5 -mr-1.5 rounded-full">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                    </button>
                <div id="add-menu" class="dropdown-menu hidden">
                        <a href="#" id="add-friend-btn" class="dropdown-menu-item">添加好友</a>
                        <a href="#" id="create-group-chat-btn" class="dropdown-menu-item">发起群聊</a>
                        <a href="#" id="ai-generate-friend-btn" class="dropdown-menu-item">查找可能认识的人</a>
                        <a href="#" id="manage-groups-btn" class="dropdown-menu-item">管理分组</a>
                </div>
                </div>
            </div>
        </header>

        <main class="flex-grow main-content">
            <div class="p-4 bg-white border-b">
                <div class="flex space-x-4">
                    <button id="friends-tab" class="tab-btn active">好友</button>
                    <button id="groups-tab" class="tab-btn">群聊</button>
                </div>
            </div>

            <div id="friends-list"></div>

            <div id="groups-list" class="hidden"></div>
        </main>

        <footer class="app-dock">
             <div class="grid grid-cols-4 gap-4 text-center text-xs font-medium">
                <a href="chat.html" class="dock-item flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                        </svg>
                    </div>
                    <span>聊天</span>
                </a>
                <a href="contacts.html" class="dock-item active flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M7 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                            <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216Z"/>
                            <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                        </svg>
                    </div>
                    <span>通讯录</span>
                </a>
                <a href="moments.html" class="dock-item flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <span>朋友圈</span>
                </a>
                <a href="me.html" class="dock-item flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z"/>
                        </svg>
                    </div>
                    <span>我</span>
                </a>
            </div>
        </footer>
    </div>
    
    <style>
        .tab-btn { padding: 4px 8px; border-radius: 6px; color: #6b7280; }
        .tab-btn.active { background-color: var(--theme-color); color: white; font-weight: 500; }
        .group-header { padding: 8px 16px; background-color: #f3f4f6; color: #6b7280; font-size: 0.875rem; font-weight: 500; border-bottom: 1px solid #e5e7eb; cursor: pointer; }
        .group-header summary { display: flex; justify-content: space-between; }

        /* 底部标签栏美化样式 */
        .dock-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px 4px;
            border-radius: 12px;
            color: #6b7280; /* 默认灰色 */
        }

        .dock-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--theme-color, #3b82f6);
        }

        .dock-item.active {
            color: var(--theme-color, #3b82f6);
        }

        .dock-item .icon-container {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .dock-item:hover .icon-container {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--theme-color, #3b82f6);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .dock-item.active .icon-container {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--theme-color, #3b82f6);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* 深色模式适配 */
        html.dark .dock-item {
            color: #9ca3af;
        }

        html.dark .dock-item:hover {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--theme-color, #3b82f6);
        }

        html.dark .dock-item.active {
            color: var(--theme-color, #3b82f6);
        }

        html.dark .dock-item .icon-container {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>

    <script type="module">
        import { db } from './db.js';
        import { showToast, promptForInput, showConfirmModal } from './ui-helpers.js';
        import { showCharacterGeneratorModal } from './characterGenerator.js';

        const friendsList = document.getElementById('friends-list');
        const groupsList = document.getElementById('groups-list');
        const manageGroupsBtn = document.getElementById('manage-groups-btn');

        async function loadAndRenderContacts() {

            friendsList.innerHTML = '';
            groupsList.innerHTML = '';

            // More robust data fetching.
            const allChars = await db.chats.toArray();
            const allFriends = allChars.filter(c => !c.isGroup);
            const allDbGroups = await db.xzoneGroups.toArray();
            const allChats = await db.chats.toArray();
            const allGroupsFromChats = allChats.filter(chat => chat.isGroup);
            

            // 清空旧的群聊列表
            groupsList.innerHTML = ''; 

            allGroupsFromChats.sort((a, b) => a.name.localeCompare(b.name)).forEach(groupChat => {
                // 1. 创建 a 标签
                const link = document.createElement('a');
                link.href = `chatRoom.html?id=${groupChat.id}`;
                link.className = 'flex items-center p-4 border-b hover:bg-gray-50';

                // 2. 创建 img 标签
                const img = document.createElement('img');
                // 只取 URL 部分，即使 groupAvatar 字段是损坏的，也能避免注入多余的HTML
                img.src = groupChat.settings.groupAvatar || fallback;
                img.onerror = () => { img.src = 'https://static.vecteezy.com/system/resources/previews/026/019/617/non_2x/group-profile-avatar-icon-default-social-media-forum-profile-photo-vector.jpg'; };
                img.className = 'avatar w-12 h-12 rounded-lg object-cover bg-gray-200'; // 确保有默认样式

                // 3. 创建 span 标签
                const span = document.createElement('span');
                span.className = 'font-bold text-gray-800 ml-3';
                span.textContent = `${groupChat.name} (${groupChat.members.length + 1})`;

                // 4. 组装并添加到列表中
                link.appendChild(img);
                link.appendChild(span);
                groupsList.appendChild(link);
            });
            allFriends.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

            const ungroupedFriends = allFriends
                .filter(c => !c.groupId)
                .sort((a, b) => (a.name || a.realName).localeCompare(b.name || b.realName));

            const groupedFriends = allDbGroups
                .map(group => ({
                    ...group,
                    members: allFriends
                        .filter(c => c.groupId === group.id)
                        .sort((a, b) => (a.name || a.realName).localeCompare(b.name || b.realName))
                }))
                .sort((a, b) => a.name.localeCompare(b.name));

                const renderFriendList = (friends) => {
                    return friends.map(chat => {
                        const status = chat.status || { text: '在线', color: '#2ecc71' };
                        const signature = chat.signature || '（暂无签名）';
                        const colorMap = { green: '#2ecc71', yellow: '#f1c40f', red: '#e74c3c', gray: '#95a5a6' };
                        const dotColor = colorMap[status.color] || status.color || '#95a5a6';

                        return `
                            <a href="charProfile.html?id=${chat.id}" class="block border-b border-gray-100">
                                <div class="flex items-start p-4 interactive-list-item">
                                    <div class="flex-shrink-0 mr-3">
                                        <img src="${chat.settings?.aiAvatar || 'https://files.catbox.moe/kkll8p.svg'}" class="avatar">
                                    </div>
                                    <div class="pt-1 flex-grow">
                                        <p class="font-bold text-gray-800">${chat.name || chat.realName}</p>
                                        <div class="flex items-center gap-2 text-sm text-gray-500">
                                            <span class="w-2.5 h-2.5 rounded-full inline-block" style="background-color: ${dotColor};"></span>
                                            <span class="truncate">${signature}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                        `;
                    }).join('');
                };
            
            groupedFriends.forEach(group => {
                if (group.members.length > 0) {
                    const details = document.createElement('details');
                    details.open = true;
                    details.innerHTML = `
                        <summary class="group-header">
                            <span>${group.name}</span>
                            <span>${group.members.length}</span>
                        </summary>
                        <div class="contact-list-container bg-white">${renderFriendList(group.members)}</div>
                    `;
                    friendsList.appendChild(details);
                }
            });
            
            if (ungroupedFriends.length > 0) {
                const details = document.createElement('details');
                details.open = true;
                details.innerHTML = `
                    <summary class="group-header">
                        <span>未分组</span>
                        <span>${ungroupedFriends.length}</span>
                    </summary>
                    <div class="contact-list-container bg-white">${renderFriendList(ungroupedFriends)}</div>
                `;
                friendsList.appendChild(details);
            }

            allDbGroups.sort((a, b) => a.name.localeCompare(b.name)).forEach(group => {
                // ... group rendering logic is fine, can be left as is ...
            });
        }

        function setupEventListeners() {
            // --- Tab Switching and Dropdown Logic  ---
            const friendsTab = document.getElementById('friends-tab');
            const groupsTab = document.getElementById('groups-tab');

            friendsTab.addEventListener('click', () => {
                friendsTab.classList.add('active');
                groupsTab.classList.remove('active');
                friendsList.classList.remove('hidden');
                groupsList.classList.add('hidden');
            });
            groupsTab.addEventListener('click', () => {
                groupsTab.classList.add('active');
                friendsTab.classList.remove('active');
                groupsList.classList.remove('hidden');
                friendsList.classList.add('hidden');
            });
            
            const addBtn = document.getElementById('add-btn');
            const addMenu = document.getElementById('add-menu');
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                addMenu.classList.toggle('hidden');
                addBtn.classList.toggle('active', !addMenu.classList.contains('hidden'));
            });
            document.getElementById('add-friend-btn').addEventListener('click', async () => {
                const charName = await promptForInput("请输入您想添加的好友名字：", "例如：小明、小红", false, false, '');
                if(charName && charName.trim() !== '') {
                    window.location.href = `charEditProfile.html?isNew=true&name=${encodeURIComponent(charName)}`;
                }
            });

            const createGroupBtn = addMenu.querySelector('a:nth-child(2)');
            createGroupBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // 跳转到一个新的页面来选择联系人
                window.location.href = 'contactsPicker.html';
                addMenu.classList.add('hidden');
            });
            window.addEventListener('click', () => {
                if (!addMenu.classList.contains('hidden')) {
                    addMenu.classList.add('hidden');
                    addBtn.classList.remove('active');
                }
            });
            manageGroupsBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        showGroupManagementModal();
                        addMenu.classList.add('hidden'); // 关闭下拉菜单
                });
                document.getElementById('ai-generate-friend-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        showCharacterGeneratorModal();
                        addMenu.classList.add('hidden');
                });
        }

        /**
         * 创建并显示分组管理模态框
         */
                async function showGroupManagementModal() {
                        const allGroups = await db.xzoneGroups.toArray();

                        // 动态创建模态框HTML
                        const modalId = 'group-management-modal';
                        document.getElementById(modalId)?.remove(); // 确保移除旧的

                        const modal = document.createElement('div');
                        modal.id = modalId;
                        modal.className = 'modal visible';
                        modal.innerHTML = `
        <div class="modal-content bg-white rounded-lg w-full max-w-sm max-h-[80vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h3 class="font-semibold text-lg">管理分组</h3>
                <button id="add-new-group-btn" class="text-sm font-semibold" style="color: var(--theme-color);">新建分组</button>
            </header>
            <main id="group-list-editor" class="flex-grow p-4 space-y-2 overflow-y-auto">
                ${allGroups.length > 0 ? allGroups.map(group => `
                    <div class="flex items-center justify-between p-2 rounded hover:bg-gray-100">
                        <span class="group-name-display">${group.name}</span>
                        <div class="flex items-center gap-3">
                            <button class="edit-group-btn text-xs text-gray-500 hover:underline" data-group-id="${group.id}" data-group-name="${group.name}">重命名</button>
                            <button class="delete-group-btn text-xs text-red-500 hover:underline" data-group-id="${group.id}" data-group-name="${group.name}">删除</button>
                        </div>
                    </div>
                `).join('') : '<p class="text-center text-gray-500 text-sm">还没有任何分组</p>'}
            </main>
            <footer class="p-2 border-t">
                <button id="close-group-modal-btn" class="modal-btn modal-btn-cancel w-full">关闭</button>
            </footer>
        </div>
    `;
                        document.body.appendChild(modal);

                        // 为模态框内的按钮绑定事件
                        document.getElementById('close-group-modal-btn').addEventListener('click', () => modal.remove());
                        document.getElementById('add-new-group-btn').addEventListener('click', handleCreateGroup);

                        modal.querySelectorAll('.edit-group-btn').forEach(btn => btn.addEventListener('click', handleRenameGroup));
                        modal.querySelectorAll('.delete-group-btn').forEach(btn => btn.addEventListener('click', handleDeleteGroup));
                }

                /**
                 * 处理新建分组的逻辑
                 */
                async function handleCreateGroup() {
                        const newGroupName = await promptForInput("请输入新的分组名：", "例如：我的新分组", false, false, '');
                        if (!newGroupName || !newGroupName.trim()) return;

                        try {
                                const existing = await db.xzoneGroups.where('name').equals(newGroupName.trim()).first();
                                if (existing) {
                                        showToast(`分组 "${newGroupName.trim()}" 已经存在了！`, 'error');
                                        return;
                                }
                                await db.xzoneGroups.add({ name: newGroupName.trim() });
                                showToast('分组创建成功！');
                                await showGroupManagementModal(); // 刷新模态框
                                await loadAndRenderContacts(); // 刷新通讯录主列表
                        } catch (error) {
                                showToast('创建失败，请查看控制台。', 'error');
                                console.error(error);
                        }
                }

                /**
                 * 处理重命名分组的逻辑
                 */
                async function handleRenameGroup(event) {
                        const groupId = parseInt(event.target.dataset.groupId);
                        const oldName = event.target.dataset.groupName;

                        const newName = await promptForInput(`重命名分组 "${oldName}"`, "输入新名称", false, false, oldName);
                        if (!newName || !newName.trim() || newName.trim() === oldName) return;

                        try {
                                const existing = await db.xzoneGroups.where('name').equals(newName.trim()).first();
                                if (existing && existing.id !== groupId) {
                                        showToast(`分组名 "${newName.trim()}" 已被占用！`, 'error');
                                        return;
                                }
                                await db.xzoneGroups.update(groupId, { name: newName.trim() });
                                showToast('重命名成功！');
                                await showGroupManagementModal();
                                await loadAndRenderContacts();
                        } catch (error) {
                                showToast('重命名失败，请查看控制台。', 'error');
                                console.error(error);
                        }
                }

                /**
                 * 处理删除分组的逻辑
                 */
                async function handleDeleteGroup(event) {
                        const groupId = parseInt(event.target.dataset.groupId);
                        const groupName = event.target.dataset.groupName;

                        const confirmed = await showConfirmModal(
                                '删除分组',
                                `确定要删除分组 “${groupName}” 吗？\n该分组下的所有角色将被移动到“未分组”。`,
                                '删除',
                                '取消'
                        );

                        if (confirmed) {
                                try {
                                        await db.transaction('rw', db.xzoneGroups, db.chats, async () => {
                                                // 1. 将所有属于该分组的角色 groupId 设置为 null
                                                await db.chats.where('groupId').equals(groupId).modify({ groupId: null });
                                                // 2. 删除分组本身
                                                await db.xzoneGroups.delete(groupId);
                                        });
                                        showToast('分组已删除！');
                                        await showGroupManagementModal();
                                        await loadAndRenderContacts();
                                } catch (error) {
                                        showToast('删除失败，请查看控制台。', 'error');
                                        console.error(error);
                                }
                        }
                }

        let hasInitialized = false;
        document.addEventListener('DOMContentLoaded', () => {
            if (!hasInitialized) {
                init(); // The init function will call loadAndRenderContacts and setupEventListeners
                hasInitialized = true;
            }
        });

        window.addEventListener('pageshow', (event) => {
            if (event.persisted) {
                loadAndRenderContacts();
            }
        });

        async function init() {
            await loadAndRenderContacts();
            setupEventListeners();
        }
    </script>
</body>
</html>
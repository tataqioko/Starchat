<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <script>
      (function() {
        try {
          // 使用同步的 localStorage 获取主题设置，这比数据库快得多
          const themeMode = localStorage.getItem('starchat-theme-mode'); 
          const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          
          if (themeMode === 'dark' || (themeMode === 'auto' && systemPrefersDark)) {
            document.documentElement.classList.add('dark');
          }
          // 如果是 'light' 或者 localStorage 中没设置，则不做任何事，保持默认
        } catch (e) {
          // 捕获异常，以防 localStorage 被禁用
        }
      })();
    </script>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href="./manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="星链小手机">
    <meta name="theme-color" content="#3b82f6"/>
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
       
    <title>聊天</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="./dexie.min.js"></script>    
    <link rel="stylesheet" href="sharedStyles.css">
    <script type="module" src="applyGlobalStyles.js" defer></script> 

 
    <style>
        .avatar-container {
            position: relative;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .unread-dot {
            position: absolute;
            top: -4px;
            right: -4px;
            height: 18px;
            min-width: 18px;
            padding: 0 5px;
            background-color: #ef4444; /* 红色 */
            color: white;
            font-size: 11px;
            font-weight: bold;
            border-radius: 9999px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);

            /* 使用 Flexbox 完美居中数字 */
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1; /* 重置 line-height */
        }

        /* 底部标签栏美化样式 */
        .dock-item {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 8px 4px;
            border-radius: 12px;
            color: #6b7280; /* 默认灰色 */
        }

        .dock-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: var(--theme-color, #3b82f6);
        }

        .dock-item.active {
            color: var(--theme-color, #3b82f6);
        }

        .dock-item .icon-container {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .dock-item:hover .icon-container {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--theme-color, #3b82f6);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .dock-item.active .icon-container {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--theme-color, #3b82f6);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* 深色模式适配 */
        html.dark .dock-item {
            color: #9ca3af;
        }

        html.dark .dock-item:hover {
            background-color: rgba(59, 130, 246, 0.15);
            color: var(--theme-color, #3b82f6);
        }

        html.dark .dock-item.active {
            color: var(--theme-color, #3b82f6);
        }

        html.dark .dock-item .icon-container {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <div class="w-full h-full mx-auto flex flex-col">
        <header class="app-header">
            <div class="flex items-center justify-between relative">
                <a href="index.html" class="header-btn p-1.5 -ml-1.5 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
                </a>
                <h1 class="text-base font-semibold text-gray-800"></h1> <div class="relative">
                    <button id="add-btn" class="header-btn p-1.5 -mr-1.5 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/></svg>
                    </button>
                    <div id="add-menu" class="dropdown-menu hidden">
                        <a href="#" id="add-friend-btn" class="dropdown-menu-item">添加好友</a>
                        <a href="#" id="ai-generate-friend-btn" class="dropdown-menu-item">查找可能认识的人</a>
                        <a href="#" id="create-group-chat-btn" class="dropdown-menu-item">发起群聊</a>
                    </div>
                </div>
            </div>
        </header>

        <main id="chat-list" class="flex-grow main-content">
            </main>

        <footer class="app-dock">
            <div class="grid grid-cols-4 gap-4 text-center text-xs font-medium">
                <a href="chat.html" class="dock-item active flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M2.678 11.894a1 1 0 0 1 .287.801 10.97 10.97 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8.06 8.06 0 0 0 8 14c3.996 0 7-2.807 7-6 0-3.192-3.004-6-7-6S1 4.808 1 8c0 1.468.617 2.83 1.678 3.894zm-.493 3.905a21.682 21.682 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a9.68 9.68 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9.06 9.06 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105z"/>
                        </svg>
                    </div>
                    <span>聊天</span>
                </a>
                <a href="contacts.html" class="dock-item flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M7 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H7Zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"/>
                            <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216Z"/>
                            <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"/>
                        </svg>
                    </div>
                    <span>通讯录</span>
                </a>
                <a href="moments.html" class="dock-item flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/>
                        </svg>
                    </div>
                    <span>朋友圈</span>
                </a>
                <a href="me.html" class="dock-item flex flex-col items-center">
                    <div class="icon-container w-8 h-8 rounded-xl flex items-center justify-center mb-1 transition-all duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6Zm2-3a2 2 0 1 1-4 0 2 2 0 0 1 4 0Zm4 8c0 1-1 1-1 1H3s-1 0-1-1 1-4 6-4 6 3 6 4Zm-1-.004c-.001-.246-.154-.986-.832-1.664C11.516 10.68 10.289 10 8 10c-2.29 0-3.516.68-4.168 1.332-.678.678-.83 1.418-.832 1.664h10Z"/>
                        </svg>
                    </div>
                    <span>我</span>
                </a>
            </div>
        </footer>
    </div>

    <script type="module">
        import { db } from './db.js';
        import { showToast, promptForInput } from './ui-helpers.js';
        import { showCharacterGeneratorModal } from './characterGenerator.js';

        const chatListContainer = document.getElementById('chat-list');
        const notificationChannel = new BroadcastChannel('starchat_notifications');
        let renderTimeout; // 用于防抖的计时器
        let isRendering = false;
        
        // 监听来自后台的消息
        notificationChannel.onmessage = (event) => {
            if (event.data && event.data.type === 'new_message') {
                console.log('接收到新消息广播，正在刷新聊天列表...');
                requestRender();
            }
        };

        // format the preview
        function formatMessagePreview(message) {
            if (!message) return "暂无消息";
            // Handle different message types for a better preview
            switch (message.type) {
                case 'sticker': return '[表情]';
                case 'transfer': return `[转账] ¥${message.amount.toFixed(2)}`;
                case 'user_photo': return '[图片]';
                case 'image_url': return '[图片]';
                case 'voice_message': return '[语音]';
                case 'share_link': return `[链接] ${message.title}`;
                default:
                    // For regular text, truncate if it's too long
                    const content = message.content || '';
                    return content.length > 20 ? content.substring(0, 20) + '...' : content;
            }
        }
        
        /**
         * Formats a timestamp into a user-friendly string based on how old it is.
         * @param {Date | string | number} timestamp - The timestamp of the message.
         * @returns {string} - The formatted time string (e.g., "15:30", "昨天", "星期三", "2025/7/15").
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';

            const messageDate = new Date(timestamp);
            const now = new Date();

            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfYesterday = new Date(startOfToday);
            startOfYesterday.setDate(startOfYesterday.getDate() - 1);
            
            // Find the start of the current week (assuming Monday is the first day)
            const startOfWeek = new Date(startOfToday);
            const dayOfWeek = now.getDay(); // Sunday = 0, Monday = 1, ...
            const diff = (dayOfWeek === 0) ? 6 : dayOfWeek - 1; // Adjust for Sunday
            startOfWeek.setDate(startOfWeek.getDate() - diff);

            if (messageDate >= startOfToday) {
                // Today: Show time
                return messageDate.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', hour12: false });
            } else if (messageDate >= startOfYesterday) {
                // Yesterday
                return '昨天';
            } else if (messageDate >= startOfWeek) {
                // This week: Show day of the week
                return messageDate.toLocaleDateString('zh-CN', { weekday: 'long' });
            } else {
                // Older than a week: Show full date
                return messageDate.toLocaleDateString('zh-CN');
            }
        }

        async function loadAndRenderChats() {
                if (isRendering) {
                        console.log("渲染被阻止，因为另一个渲染正在进行中。");
                        return;
                }
                isRendering = true; // 进入函数后，立刻“上锁”
                console.log("执行渲染: loadAndRenderChats");
                
                while (chatListContainer.firstChild) {
                        chatListContainer.removeChild(chatListContainer.firstChild);
                }

                const chats = await db.chats.orderBy('lastMessageTimestamp').reverse().toArray();

                if (chats.length === 0) {
                        chatListContainer.innerHTML = `<p class="text-center text-gray-500 mt-8">没有聊天记录</p>`;
                        return;
                }

                chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-list-item block border-b border-gray-100 cursor-pointer';            
                        
                        // 3. 直接从 chat 对象上获取最后一条消息和时间戳
                        
                        const lastMessage = chat.lastMessageContent; // 直接获取
                        const previewText = formatMessagePreview(lastMessage); // 传递给格式化函数
                        const messageTime = formatTimestamp(chat.lastMessageTimestamp); // 直接使用时间戳

                        let avatarUrl = '';
                        if (chat.isGroup) {
                        avatarUrl = chat.settings?.groupAvatar || 'https://i.postimg.cc/gc3QYCDy/1-NINE7-Five.jpg';
                        } else {
                        avatarUrl = chat.settings?.aiAvatar || 'https://files.catbox.moe/kkll8p.svg';
                        }

                        chatItem.innerHTML = `
                        <div class="flex items-start p-4 interactive-list-item">
                                <div class="flex-shrink-0 mr-3 avatar-container avatar-link-target" data-id="${chat.id}"> 
                                <img src="${avatarUrl}" class="avatar">
                                <div class="unread-dot"></div>
                                </div>
                                <div class="pt-1 flex-grow">
                                <div class="flex justify-between items-baseline">
                                        <p class="font-bold text-gray-800">${chat.name || chat.realName}</p>
                                        <p class="text-xs text-gray-400">${messageTime}</p>
                                </div>
                                <p class="text-sm text-gray-500 message-preview truncate">${previewText}</p> 
                                </div>
                        </div>
                        `;

                        if (!chat.isGroup) {
                        const avatarElement = chatItem.querySelector('.avatar-link-target');
                        avatarElement.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const id = e.currentTarget.dataset.id;
                                window.location.href = `charProfile.html?id=${id}`;
                        });
                        }

                        chatItem.addEventListener('click', () => {
                        window.location.href = `chatRoom.html?id=${chat.id}`;
                        });

                        const unreadDot = chatItem.querySelector('.unread-dot');
                        const unreadCount = chat.unreadCount || 0;
                        if (unreadCount > 0) {
                        unreadDot.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        unreadDot.style.display = 'flex'; // Use flex for centering as per your CSS
                        } else {
                        unreadDot.style.display = 'none';
                        }
                        
                        // This is the single, correct place to append the child.
                        chatListContainer.appendChild(chatItem);
                });
                isRendering = false;
        }

        function setupEventListeners() {

            // Dropdown Menu Logic
            const addBtn = document.getElementById('add-btn');
            const addMenu = document.getElementById('add-menu');
            addBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                addMenu.classList.toggle('hidden');
                addBtn.classList.toggle('active', !addMenu.classList.contains('hidden'));
            });
            
            // Add Friend Logic
            document.getElementById('add-friend-btn').addEventListener('click', async () => {
                const charName = await promptForInput("请输入您想添加的好友名字：", "例如：小明、小红", false, false, '');
                if(charName && charName.trim() !== '') {
                    // This is a simplified flow. A real app would save this name and pass it
                    // as a default value to the edit page.
                    window.location.href = `charEditProfile.html?isNew=true&name=${encodeURIComponent(charName)}`;
                }
            });

            const createGroupBtn = document.getElementById('create-group-chat-btn');
                createGroupBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        window.location.href = 'contactsPicker.html';
                        addMenu.classList.add('hidden');
                });

            // Hide menu if clicking elsewhere
            window.addEventListener('click', () => {
                if (!addMenu.classList.contains('hidden')) {
                    addMenu.classList.add('hidden');
                    addBtn.classList.remove('active');
                }
            });

            document.getElementById('ai-generate-friend-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        showCharacterGeneratorModal();
                        addMenu.classList.add('hidden'); // 关闭下拉菜单
                });
        }

        //创建一个请求渲染的函数，内置防抖
        function requestRender() {
            clearTimeout(renderTimeout);
            // 使用一个非常短的延迟 (20毫秒) 来合并短时间内的多次渲染请求
            renderTimeout = setTimeout(loadAndRenderChats, 20);
        }
        
        // --- 最终的初始化逻辑 ---
        document.addEventListener('DOMContentLoaded', async () => {
            setupEventListeners();
            requestRender(); // 首次加载时请求渲染
        });

        // 统一处理页面可见性变化的事件
        const handleVisibilityChange = () => {
            if (document.visibilityState === 'visible') {
                requestRender();
            }
        };

        window.addEventListener('pageshow', handleVisibilityChange);
        document.addEventListener('visibilitychange', handleVisibilityChange);

    </script>
</body>
</html>